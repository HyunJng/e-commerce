# k6 부하 테스트 개선 보고서

좋아! 네 문서 위에 바로 붙일 수 있는 **요약(Executive Summary)** 과, 끝에 붙이면 좋은 **보충 섹션**을 준비했어. 전부 “이다”체로 정리했다.

---

## 0) 요약

* **목표**: 300 RPS 하에서 병목을 식별하고 p95 지연을 낮추는 것이다.
* **핵심 조치**:

  1. 재고 차감 **조건부 UPDATE** 전환 → 행락 대기 제거
  2. **분산락 제거** → 멀티키 락 경합 해소
  3. 지갑(잔액) 차감 **조건부 UPDATE** 전환 → 직렬화 제거
* **최신 결과**: 평균 **278 RPS**, **p95 3.64s**, 실패율 **≈0%**, dropped **17k** 수준이다.
* **효과(대비 Baseline)**:

  * **처리량** +53% (181.85 → **278.39** RPS)
  * **p95** −60% (9.11s → **3.64s**)
  * **dropped** −36% (27,106 → **17,389**)
---

## 1) 목적 및 대상 선정 배경

* **목적**: 핵심 트랜잭션 경로에 대한 **처리 한계·지연 특성**을 계측하고, 장애 양상을 재현하여 **개선 과제**를 도출하는 것이다.
* **대상**

    * **주문(Order)**: 재고 차감·쿠폰·포인트 등 **원자성**과 **자원 경합**이 집중되는 경로이다.

---

## 2) 테스트 환경

* **테스트 도구**: k6
* **테스트 대상**: 주문 시나리오 API 서버
* **가상 사용자 수(VU)**: `preAllocatedVUs=300`, `maxVUs=1200`
* **실행 시간**: 약 **3분 45초**(45s+60s+90s+30s)

---

## 3) 시나리오 및 임계치

* **부하 프로파일**: `ramping-arrival-rate`

    * `startRate=50`, `→100(45s) →300(60s) →300 유지(90s) →0(30s)`
* **요청 흐름(E2E)**:

    1. `GET /api/v1/products/best`
    2. `GET /api/v1/products/{id}`
    3. `POST /api/v1/orders`
* **k6 태그**: `tags: { name: 'best' | 'item' | 'order' }`
* **임계치(Thresholds)**

    * 전역: `http_req_duration` p95 < 500ms, `http_req_failed` < 5%
    * 엔드포인트: `best`/`item` p95 < 400ms, `order` p95 < 800ms

---

## 4) 결과 요약 

### 1차 변화 비교 : 재고 차감 조건부 UPDATE 적용

| 지표                | 전 (Baseline) | 후 (조건부 UPDATE) |                      변화량 |
| ----------------- | -----------: | -------------: | -----------------------: |
| **평균 RPS**        |       181.85 |         198.09 |  **+16.24** (**+8.93%**) |
| **평균 응답시간 (avg)** |        4.30s |          3.87s | **−0.43s** (**−10.00%**) |
| **p95 응답시간**      |        9.11s |          5.83s | **−3.28s** (**−36.00%**) |
| **실패율**           |        0.02% |          0.03% | **+0.01%p** *(여전히 기준 내)* |
| **드롭된 요청**        |       27,106 |         25,456 |  **−1,650** (**−6.09%**) |

### 해석

* 재고 차감을 **조건부 UPDATE**로 전환하면서 **긴 꼬리(p95)가 36% 감소**, 평균도 10% 개선되었다.
* 처리량은 **+8.9%** 증가했고, 드롭도 **6.1%** 감소하였다.
* 실패율은 **+0.01%p**로 사실상 동일 수준이며, 임계치 내이다.
* 전역 SLA(p95 < 500ms)는 아직 미달이므로, 다음 병목 개선이 필요하다.

### 2차 변화 비교: 분산락 제거
| 지표          | 전 (조건부 UPDATE) | 후 (분산락 제거) |        변화 |
| ----------- | -------------: | ---------: | --------: |
| **평균 RPS**  |         198.09 | **202.99** | **+2.5%** |
| **avg**     |          3.87s |  **3.72s** | **−3.9%** |
| **p95**     |          5.83s |  **5.70s** | **−2.2%** |
| **p99**     |          6.30s |  **5.88s** | **−6.7%** |
| **max**     |          7.03s |  **6.78s** | **−3.6%** |
| **실패율**     |          0.03% |  **0.00%** |    **개선** |
| **dropped** |         25,456 | **24,993** | **−1.8%** |

### 해석
* 분산락 제거로 멀티 키 락 경합과 대기열이 줄며 꼬리 지연이 추가로 개선되었다.
* 전역 SLA(p95 < 500ms)는 아직 미달이므로, 다음 병목 개선이 필요하다.

### 3차: 잔액 차감 조건부 UPDATE 적용
| 지표          | 전(분산락 제거) | 후(지갑 조건부 UPDATE) |         변화 |
| ----------- | --------: | ---------------: | ---------: |
| **평균 RPS**  |    202.99 |       **278.39** | **+37.1%** |
| **avg**     |     3.72s |        **2.34s** | **−37.1%** |
| **p95**     |     5.70s |        **3.64s** | **−36.1%** |
| **p99**     |     5.88s |        **3.81s** | **−35.2%** |
| **max**     |     6.78s |        **4.58s** | **−32.5%** |
| **dropped** |    24,993 |       **17,389** | **−30.4%** |
| **실패율**     |     0.00% |        **0.00%** |          — |

### 해석
* 락 대기 제거(재고·지갑 모두 조건부 UPDATE)로 긴 꼬리(p95/p99/max)가 연쇄적으로 눌렸고, 처리량이 278 RPS까지 올라왔다.
* 여전히 전역 SLA(p95<500ms)는 미달이지만, 300 RPS 근접 구간에서 지연을 3~4초대로 안정화 되었다.
* dropped_iterations도 지속적으로 감소 중(27k → 25k → 17k)
